<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<script src="//use.typekit.net/ndx7bht.js"></script>
		<script>try{Typekit.load();}catch(e){}</script>
		<link rel="stylesheet" type="text/css" href="style.css">
		<script type="text/javascript" src="p5/p5.js"></script>
		<style>
			html, body{
				margin: 0;
				padding: 0;
				background: #333333;
			}
		</style>
	</head>
	<script type="text/javascript">

	// Global variables
	var WIDTH = 1200;
	var HEIGHT = 2000;
	var maxValue = 0;
	var maxRectLength = 500;
	var rectHeight = 8;
	var drawValues = [];
	var drawNames = [];
	var drawNumbers = [];
	var spaceBetween = 15;
	var marginX = 20;
	var buttonWidth = 100;
	var buttonHeight = 25;
	var suppliers = true;
	var secondaryPosition = 0;
	var selectedCompany = 0;
	var marketCap = [];
	var percentCost = [];
	var percentRevenue = [];
	var countryCode = [];
	var countryName = [];
	var industry = [];
	var lat = [];
	var lon = [];
	var mainSubtitlesY = 140;
	var startDataY = mainSubtitlesY + 115;
	var mainButtonsY = mainSubtitlesY + 45;
	var secondaryButtonsY = mainSubtitlesY + 45;
	var secondaryButtonsX = 240;
	var appleY = mainSubtitlesY + 23;
	var line1Y = 95;
	var line2Y = 210;
	var img;

	function preload(){
		console.log('Starting the loading process...')
		suppliersMarketCapTable = loadTable('data/05_Supplier_MarketCap.csv');
		suppliersPercCostTable = loadTable('data/05_Supplier_PercCost.csv');
		suppliersPercRevTable = loadTable('data/05_Supplier_PercRev.csv');
		customersMarketCapTable = loadTable('data/05_Customer_MarketCap.csv');
		customerPercCostTable = loadTable('data/05_Customer_PercCost.csv');
		customerPercRevTable = loadTable('data/05_Customer_PercRev.csv');
		img = loadImage('data/World_Map_2-01.png');
		console.log('Done loading base data...');
	}

	function setup(){
		createCanvas(WIDTH, HEIGHT);
		colorMode(HSB, 360, 100, 100, 100);
		textFont("din-condensed-web")

		// Calculate maximum value
		for (var i = 1; i < 101; i++) {
			if (suppliersMarketCapTable.getColumn(4)[i] != 'N/A'){
				maxValue = max(suppliersMarketCapTable.getColumn(4)[i], maxValue);
			}
			else {
			}
		};

		// Calculate initial draw values
		for (var i = 1; i < 101; i++) {
			drawValues[i-1] = map(suppliersMarketCapTable.getColumn(4)[i], 0, maxValue, 0, maxRectLength);
			drawNames[i-1] = suppliersMarketCapTable.getColumn(1)[i];
			drawNumbers[i-1] = suppliersMarketCapTable.getColumn(4)[i];
			marketCap[i-1] = suppliersMarketCapTable.getColumn(4)[i];
			percentCost[i-1] = suppliersMarketCapTable.getColumn(6)[i];
			percentRevenue[i-1] = suppliersMarketCapTable.getColumn(5)[i];
			countryCode[i-1] = suppliersMarketCapTable.getColumn(2)[i];
			industry[i-1] = suppliersMarketCapTable.getColumn(3)[i];
			countryName[i-1] = suppliersMarketCapTable.getColumn(7)[i];
			lat[i-1] = suppliersMarketCapTable.getColumn(8)[i];
			lon[i-1] = suppliersMarketCapTable.getColumn(9)[i];
		};
	}

	function drawButtons(){
		// Main buttons
		var position = 0;
		if (suppliers){
			position = 0;
		}
		else {
			position = 1;
		}
		fill(0, 0, 30);
		noStroke();
		rect(marginX + (buttonWidth + 10) * position, mainButtonsY, buttonWidth, buttonHeight);
		noFill();
		stroke(0, 0, 100);
		strokeWeight(1);
		rect(marginX, mainButtonsY, buttonWidth, buttonHeight);
		rect(marginX + 10 + buttonWidth, mainButtonsY, buttonWidth, buttonHeight);
		noStroke();
		fill(0, 0, 100);
		textAlign(CENTER);
		textSize(12);
		text("SUPPLIERS", marginX + buttonWidth / 2, mainButtonsY + 5 + buttonHeight / 2);
		text("CUSTOMERS", marginX + buttonWidth / 2 + 10 + buttonWidth, mainButtonsY + 5 + buttonHeight / 2);

		// Secondary buttons
		fill(0, 0, 30);
		noStroke();
		rect(marginX + secondaryButtonsX + (buttonWidth + 10) * secondaryPosition, secondaryButtonsY, buttonWidth, buttonHeight);
		noFill();
		stroke(0, 0, 100);
		strokeWeight(1);
		for (var i = 0; i < 3; i++){
			rect(marginX + secondaryButtonsX + (buttonWidth + 10) * i, secondaryButtonsY, buttonWidth, buttonHeight);
		}
		noStroke();
		fill(0, 0, 100);
		textAlign(CENTER);
		text("MARKET CAP", marginX + secondaryButtonsX + buttonWidth / 2, secondaryButtonsY + 5 + buttonHeight / 2);
		text("PERCENT COST", marginX + secondaryButtonsX + buttonWidth / 2 + 10 + buttonWidth, secondaryButtonsY + 5 + buttonHeight / 2);
		text("PERCENT REVENUE", marginX + secondaryButtonsX + buttonWidth / 2 + 20 + buttonWidth * 2, secondaryButtonsY + 5 + buttonHeight / 2);
	}

	function draw(){
		background(360, 0, 20);
		drawTitles();
		drawButtons();
		checkHover();
		selectCompany();
		drawMainGraph();
		drawMap();
	}

	function drawMap(){
		image(img, 700, 400, 1280 / 2.68, 640 / 2.68);
		var mapX = 0;
		var mapY = 0;
		mapX = map(lon[selectedCompany], -180, 180, 700, 700 + (1280/2.68));
		mapY = map(lat[selectedCompany], 90, -90, 400, 400 + (640/2.68));
		//fill(0, 0, 100);
		//noStroke();
		noFill();
		stroke(0, 0, 100);
		strokeWeight(2);
		ellipse(mapX, mapY, 10, 10);
	}

	function drawTitles(){
		fill(0, 0, 100);
		noStroke();
		textSize(24);
		text('SUPPLY CHAIN', marginX, marginX);
		text('Apple Inc.', marginX, appleY);
		text('AAPL', marginX + 108, appleY);
		text('United States of America', marginX + 175, appleY);
		text('Technology Hardware & Equipm', marginX + 400, appleY);
		text('729.35 Billions', marginX + 680, appleY);
		textSize(14);
		var description = "A company's revenue is dependent on many factors, including the economic, business and financial relationships between it and its suppliers and customers. This visualization allows you to explore the 'Supply Chain' between Apple Inc. (AAPL) and its 100 largest suppliers and customers. Use the buttons below to select between customers and suppliers and to sort the data by different metrics. Click on the individual companies to bring up their detailed information."
		var credits = "Visualization created by Juan Francisco Saldarriaga for Bloomberg L.P."
		text(description, marginX, marginX + 8, 800, 200);
		text(credits, marginX, marginX + 74);
		textSize(12);
		text('Company', marginX, mainSubtitlesY);
		text('Ticker', marginX + 108, mainSubtitlesY);
		text('Country', marginX + 175, mainSubtitlesY);
		text('Industry', marginX + 400, mainSubtitlesY);
		text('Market Cap', marginX + 680, mainSubtitlesY);
		noFill();
		strokeWeight(0.5);
		stroke(0, 0, 50);
		line(marginX, marginX + line1Y, WIDTH, marginX + line1Y);
		line(marginX, marginX + line2Y, WIDTH, marginX + line2Y);
	}

	function selectCompany(){
		//noFill();
		//stroke(0, 0, 100);
		//strokeWeight(1);
		fill(0, 0, 30);
		rect(marginX, startDataY - 4 + selectedCompany * spaceBetween, marginX + maxRectLength + 105, rectHeight + 7);
		fill(0, 0, 100);
		noStroke();
		textSize(12);
		textAlign(LEFT);
		text('Company', 700, startDataY + 7);
		//text('Type', 900, startDataY + 7);
		text('Country', 700, startDataY + 50);
		text('Industry', 925, startDataY + 50);
		text('Market Cap', 700, startDataY + 93);
		text('Percent Cost', 925, startDataY + 93);
		text('Percent Revenue', 1100, startDataY + 93);
		textSize(24);
		text(drawNames[selectedCompany], 700, startDataY + 30);
		/* if (suppliers) {
			text('Supplier', 900, startDataY + 30);
		}
		else {
			text('Customer', 900, startDataY + 30);
		} */
		if (countryName[selectedCompany] == 'United Kingdom of Great Britain and Northern Ireland'){
			text('United Kingdom', 700, startDataY + 73);
		}
		else {
			text(countryName[selectedCompany], 700, startDataY + 73);
		}
		text(industry[selectedCompany], 925, startDataY + 73);
		if (marketCap[selectedCompany] > 999){
			text((int(marketCap[selectedCompany])/100)+' Billions', 700, startDataY + 116);
		}
		else if (marketCap[selectedCompany] == 'N/A'){
			text('N/A', 700, startDataY + 116);
		}
		else {
			text(int(marketCap[selectedCompany])+' Millions', 700, startDataY + 116);
		}
		text(nfc(percentCost[selectedCompany] * 100, 2) + '%', 925, startDataY + 116);
		text(nfc(percentRevenue[selectedCompany] * 100, 2) + '%', 1100, startDataY + 116);
	}

	function drawMainGraph(){
		fill(0, 0, 100);
		noStroke();
		for (var i = 0; i < drawValues.length; i++){
			rect(105, startDataY + spaceBetween * i, drawValues[i], rectHeight);
		};
		textSize(10);
		textAlign(RIGHT);
		for (var i = 0; i < drawNames.length; i++) {
			text(drawNames[i], 100, startDataY + 7 + spaceBetween * (i));
		};
		textAlign(LEFT);
		for (var i = 0; i < drawNumbers.length; i++) {
			if (drawNumbers[i] > 999){
				text((int(drawNumbers[i])/100)+' B', 110 + drawValues[i], startDataY + 7 + spaceBetween * (i));
			}
			else if (drawNumbers[i] == 'N/A'){
				text('N/A', 110, startDataY + 7 + spaceBetween * (i));
			}
			else if (drawNumbers[i] < 1){
				text(nfc(drawNumbers[i] * 100, 2) + '%', 110 + drawValues[i], startDataY + 7 + spaceBetween * i);
			}
			else {
				text(int(drawNumbers[i])+' M', 110 + drawValues[i], startDataY + 7 + spaceBetween * (i));
			}
		};
	}

	function calculateValues(){
		maxValue = 0;
		if (suppliers){
			if (secondaryPosition == 0){
				for (var i = 1; i < 101; i++) {
					if (suppliersMarketCapTable.getColumn(4)[i] != 'N/A'){
						maxValue = max(suppliersMarketCapTable.getColumn(4)[i], maxValue);
					}
					else {
					}
				};
				for (var i = 1; i < 101; i++) {
					drawValues[i-1] = map(suppliersMarketCapTable.getColumn(4)[i], 0, maxValue, 0, maxRectLength);
					drawNames[i-1] = suppliersMarketCapTable.getColumn(1)[i];
					drawNumbers[i-1] = suppliersMarketCapTable.getColumn(4)[i];
					marketCap[i-1] = suppliersMarketCapTable.getColumn(4)[i];
					percentCost[i-1] = suppliersMarketCapTable.getColumn(6)[i];
					percentRevenue[i-1] = suppliersMarketCapTable.getColumn(5)[i];
					countryCode[i-1] = suppliersMarketCapTable.getColumn(2)[i];
					industry[i-1] = suppliersMarketCapTable.getColumn(3)[i];
					countryName[i-1] = suppliersMarketCapTable.getColumn(7)[i];
					lat[i-1] = suppliersMarketCapTable.getColumn(8)[i];
					lon[i-1] = suppliersMarketCapTable.getColumn(9)[i];
				};
			}
			else if (secondaryPosition == 1){
				for (var i = 1; i < 101; i++) {
					if (suppliersPercCostTable.getColumn(6)[i] != 'N/A'){
						maxValue = max(suppliersPercCostTable.getColumn(6)[i], maxValue);
					}
					else {
					}
				};
				for (var i = 1; i < 101; i++) {
					drawValues[i-1] = map(suppliersPercCostTable.getColumn(6)[i], 0, maxValue, 0, maxRectLength);
					drawNames[i-1] = suppliersPercCostTable.getColumn(1)[i];
					drawNumbers[i-1] = suppliersPercCostTable.getColumn(6)[i];
					marketCap[i-1] = suppliersPercCostTable.getColumn(4)[i];
					percentCost[i-1] = suppliersPercCostTable.getColumn(6)[i];
					percentRevenue[i-1] = suppliersPercCostTable.getColumn(5)[i];
					countryCode[i-1] = suppliersPercCostTable.getColumn(2)[i];
					industry[i-1] = suppliersPercCostTable.getColumn(3)[i];
					countryName[i-1] = suppliersPercCostTable.getColumn(7)[i];
					lat[i-1] = suppliersPercCostTable.getColumn(8)[i];
					lon[i-1] = suppliersPercCostTable.getColumn(9)[i];
				};
			}
			else {
				for (var i = 1; i < 101; i++) {
					if (suppliersPercRevTable.getColumn(5)[i] != 'N/A'){
						maxValue = max(suppliersPercRevTable.getColumn(5)[i], maxValue);
					}
					else {
					}
				};
				for (var i = 1; i < 101; i++) {
					drawValues[i-1] = map(suppliersPercRevTable.getColumn(5)[i], 0, maxValue, 0, maxRectLength);
					drawNames[i-1] = suppliersPercRevTable.getColumn(1)[i];
					drawNumbers[i-1] = suppliersPercRevTable.getColumn(5)[i];
					marketCap[i-1] = suppliersPercRevTable.getColumn(4)[i];
					percentCost[i-1] = suppliersPercRevTable.getColumn(6)[i];
					percentRevenue[i-1] = suppliersPercRevTable.getColumn(5)[i];
					countryCode[i-1] = suppliersPercRevTable.getColumn(2)[i];
					industry[i-1] = suppliersPercRevTable.getColumn(3)[i];
					countryName[i-1] = suppliersPercRevTable.getColumn(7)[i];
					lat[i-1] = suppliersPercRevTable.getColumn(8)[i];
					lon[i-1] = suppliersPercRevTable.getColumn(9)[i];
				};
			}
		}
		else {
			if (secondaryPosition == 0){
				for (var i = 1; i < 101; i++) {
					if (customersMarketCapTable.getColumn(4)[i] != 'N/A'){
						maxValue = max(customersMarketCapTable.getColumn(4)[i], maxValue);
					}
					else {
					}
				};
				for (var i = 1; i < 101; i++) {
					drawValues[i-1] = map(customersMarketCapTable.getColumn(4)[i], 0, maxValue, 0, maxRectLength);
					drawNames[i-1] = customersMarketCapTable.getColumn(1)[i];
					drawNumbers[i-1] = customersMarketCapTable.getColumn(4)[i];
					marketCap[i-1] = customersMarketCapTable.getColumn(4)[i];
					percentCost[i-1] = customersMarketCapTable.getColumn(6)[i];
					percentRevenue[i-1] = customersMarketCapTable.getColumn(5)[i];
					countryCode[i-1] = customersMarketCapTable.getColumn(2)[i];
					industry[i-1] = customersMarketCapTable.getColumn(3)[i];
					countryName[i-1] = customersMarketCapTable.getColumn(7)[i];
					lat[i-1] = customersMarketCapTable.getColumn(8)[i];
					lon[i-1] = customersMarketCapTable.getColumn(9)[i];
				};
			}
			else if (secondaryPosition == 1){
				for (var i = 1; i < 101; i++) {
					if (customerPercCostTable.getColumn(6)[i] != 'N/A'){
						maxValue = max(customerPercCostTable.getColumn(6)[i], maxValue);
					}
					else {
					}
				};
				for (var i = 1; i < 101; i++) {
					drawValues[i-1] = map(customerPercCostTable.getColumn(6)[i], 0, maxValue, 0, maxRectLength);
					drawNames[i-1] = customerPercCostTable.getColumn(1)[i];
					drawNumbers[i-1] = customerPercCostTable.getColumn(6)[i];
					marketCap[i-1] = customerPercCostTable.getColumn(4)[i];
					percentCost[i-1] = customerPercCostTable.getColumn(6)[i];
					percentRevenue[i-1] = customerPercCostTable.getColumn(5)[i];
					countryCode[i-1] = customerPercCostTable.getColumn(2)[i];
					industry[i-1] = customerPercCostTable.getColumn(3)[i];
					countryName[i-1] = customerPercCostTable.getColumn(7)[i];
					lat[i-1] = customerPercCostTable.getColumn(8)[i];
					lon[i-1] = customerPercCostTable.getColumn(9)[i];
				};
			}
			else {
				for (var i = 1; i < 101; i++) {
					if (customerPercRevTable.getColumn(5)[i] != 'N/A'){
						maxValue = max(customerPercRevTable.getColumn(5)[i], maxValue);
					}
					else {
					}
				};
				for (var i = 1; i < 101; i++) {
					drawValues[i-1] = map(customerPercRevTable.getColumn(5)[i], 0, maxValue, 0, maxRectLength);
					drawNames[i-1] = customerPercRevTable.getColumn(1)[i];
					drawNumbers[i-1] = customerPercRevTable.getColumn(5)[i];
					marketCap[i-1] = customerPercRevTable.getColumn(4)[i];
					percentCost[i-1] = customerPercRevTable.getColumn(6)[i];
					percentRevenue[i-1] = customerPercRevTable.getColumn(5)[i];
					countryCode[i-1] = customerPercRevTable.getColumn(2)[i];
					industry[i-1] = customerPercRevTable.getColumn(3)[i];
					countryName[i-1] = customerPercRevTable.getColumn(7)[i];
					lat[i-1] = customerPercRevTable.getColumn(8)[i];
					lon[i-1] = customerPercRevTable.getColumn(9)[i];
				};
			}
		}
	}

	function mousePressed(){
		if (marginX < mouseX && mouseX < marginX + buttonWidth && mainButtonsY < mouseY && mouseY < mainButtonsY + buttonHeight){
			suppliers = true;
			calculateValues();
			selectedCompany = 0;
			console.log('suppliers');
		}
		if (marginX + buttonWidth + 10 < mouseX && mouseX < marginX + buttonWidth * 2 + 20 && mainButtonsY < mouseY && mouseY < mainButtonsY + buttonHeight){
			suppliers = false;
			calculateValues();
			selectedCompany = 0;
			console.log('customers');
		}
		if (marginX + secondaryButtonsX < mouseX && mouseX < marginX + secondaryButtonsX + buttonWidth && secondaryButtonsY < mouseY && mouseY < secondaryButtonsY + buttonHeight){
			secondaryPosition = 0;
			calculateValues();
			selectedCompany = 0;
			console.log('market cap');
		}
		if (marginX + secondaryButtonsX + buttonWidth + 10 < mouseX && mouseX < marginX + secondaryButtonsX + buttonWidth * 2 + 10 && secondaryButtonsY < mouseY && mouseY < secondaryButtonsY + buttonHeight){
			secondaryPosition = 1;
			calculateValues();
			selectedCompany = 0;
			console.log('percent cost');
		}
		if (marginX + secondaryButtonsX + buttonWidth * 2 + 20 < mouseX && mouseX < marginX + secondaryButtonsX + buttonWidth * 3 + 20 && secondaryButtonsY < mouseY && mouseY < secondaryButtonsY + buttonHeight){
			secondaryPosition = 2;
			calculateValues();
			selectedCompany = 0;
			console.log('percent revenue');
		}
		if (marginX < mouseX && mouseX < marginX + marginX + maxRectLength + 105 && startDataY - 4 < mouseY && mouseY < startDataY + spaceBetween * 100){
			selectedCompany = floor((mouseY - startDataY) / spaceBetween);
		}
	}

	function checkHover(){
		if ((marginX < mouseX && mouseX < marginX + buttonWidth && mainButtonsY < mouseY && mouseY < mainButtonsY + buttonHeight) || (marginX + buttonWidth + 10 < mouseX && mouseX < marginX + buttonWidth * 2 + 20 && mainButtonsY < mouseY && mouseY < mainButtonsY + buttonHeight) || (marginX + secondaryButtonsX < mouseX && mouseX < marginX + secondaryButtonsX + buttonWidth && secondaryButtonsY < mouseY && mouseY < secondaryButtonsY + buttonHeight) || (marginX + secondaryButtonsX + buttonWidth + 10 < mouseX && mouseX < marginX + secondaryButtonsX + buttonWidth * 2 + 10 && secondaryButtonsY < mouseY && mouseY < secondaryButtonsY + buttonHeight) || (marginX + secondaryButtonsX + buttonWidth * 2 + 20 < mouseX && mouseX < marginX + secondaryButtonsX + buttonWidth * 3 + 20 && secondaryButtonsY < mouseY && mouseY < secondaryButtonsY + buttonHeight) || (marginX < mouseX && mouseX < marginX + marginX + maxRectLength + 105 && startDataY - 4 < mouseY && mouseY < startDataY + spaceBetween * 100)){
			cursor(HAND);
		}
		else {
			cursor(ARROW);
		}
	}

	function keyPressed(){
		if (keyCode === DOWN_ARROW && selectedCompany < 99){
			selectedCompany++;
		}
		else if (keyCode === UP_ARROW && selectedCompany > 0){
			selectedCompany--;
		}
		return false;
	}

	</script>
</html>